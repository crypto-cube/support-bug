<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Support Bug Tracker</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    background: #0d1117;
    color: #c9d1d9;
    min-height: 100vh;
    padding: 2rem;
  }

  header {
    max-width: 900px;
    margin: 0 auto 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    font-size: 1.4rem;
    font-weight: 600;
    color: #e6edf3;
  }

  .btn-new {
    background: #238636;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.45rem 1rem;
    font-size: 0.85rem;
    cursor: pointer;
    font-weight: 500;
  }

  .btn-new:hover { background: #2ea043; }

  .stats {
    max-width: 900px;
    margin: 0 auto 1.5rem;
    display: flex;
    gap: 1rem;
  }

  .stat {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 8px;
    padding: 0.75rem 1.25rem;
    font-size: 0.8rem;
    color: #8b949e;
  }

  .stat strong {
    font-size: 1.2rem;
    display: block;
    margin-bottom: 0.15rem;
    color: #e6edf3;
  }

  #issues {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1px;
    background: #30363d;
    border: 1px solid #30363d;
    border-radius: 8px;
    overflow: hidden;
  }

  .issue {
    display: grid;
    grid-template-columns: 2.5rem 1fr auto;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: #161b22;
    text-decoration: none;
    transition: background 0.15s;
  }

  .issue:hover { background: #1c2129; }

  .icon {
    font-size: 1.25rem;
    text-align: center;
    line-height: 1;
  }

  .body { min-width: 0; }

  .title {
    font-size: 0.9rem;
    font-weight: 500;
    color: #e6edf3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .meta {
    font-size: 0.75rem;
    color: #8b949e;
    margin-top: 0.15rem;
  }

  .age {
    font-size: 0.75rem;
    color: #8b949e;
    white-space: nowrap;
    text-align: right;
  }

  .empty, .error, .loading {
    max-width: 900px;
    margin: 0 auto;
    text-align: center;
    color: #8b949e;
    padding: 3rem 1rem;
    font-size: 0.9rem;
  }

  .error { color: #f85149; }

  .legend {
    max-width: 900px;
    margin: 1.5rem auto 0;
    display: flex;
    gap: 1.5rem;
    font-size: 0.75rem;
    color: #8b949e;
  }

  .legend span { display: flex; align-items: center; gap: 0.35rem; }

  /* ── Modal ─────────────────────────────────────── */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity .15s;
  }

  .overlay.open {
    opacity: 1;
    pointer-events: auto;
  }

  .modal {
    background: #161b22;
    border: 1px solid #30363d;
    border-radius: 10px;
    width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #30363d;
  }

  .modal-head h2 {
    font-size: 1rem;
    font-weight: 600;
    color: #e6edf3;
  }

  .modal-close {
    background: none;
    border: none;
    color: #8b949e;
    font-size: 1.3rem;
    cursor: pointer;
    line-height: 1;
  }

  .modal-close:hover { color: #e6edf3; }

  .modal-body {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .modal-body input,
  .modal-body textarea {
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    color: #c9d1d9;
    padding: 0.5rem 0.75rem;
    font-size: 0.85rem;
    font-family: inherit;
    outline: none;
    resize: vertical;
  }

  .modal-body input:focus,
  .modal-body textarea:focus { border-color: #58a6ff; }


  .modal-foot {
    padding: 0.75rem 1.25rem;
    border-top: 1px solid #30363d;
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .btn-cancel {
    background: #21262d;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 0.45rem 1rem;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .btn-cancel:hover { background: #30363d; }

  .btn-submit {
    background: #238636;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 0.45rem 1rem;
    font-size: 0.85rem;
    cursor: pointer;
    font-weight: 500;
  }

  .btn-submit:hover { background: #2ea043; }
  .btn-submit:disabled { opacity: .5; cursor: not-allowed; }

  .modal-error {
    color: #f85149;
    font-size: 0.8rem;
    display: none;
  }

  /* ── File Upload ────────────────────────────────── */
  .drop-zone {
    border: 2px dashed #30363d;
    border-radius: 6px;
    padding: 1rem;
    text-align: center;
    font-size: 0.8rem;
    color: #8b949e;
    cursor: pointer;
    transition: border-color .15s, background .15s;
  }

  .drop-zone:hover,
  .drop-zone.dragover {
    border-color: #58a6ff;
    background: rgba(88,166,255,.06);
  }

  .file-list {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #0d1117;
    border: 1px solid #30363d;
    border-radius: 6px;
    padding: 0.35rem 0.6rem;
    font-size: 0.8rem;
    color: #c9d1d9;
  }

  .file-item .fname {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-item .fsize {
    color: #8b949e;
    font-size: 0.75rem;
    white-space: nowrap;
  }

  .file-item .fremove {
    background: none;
    border: none;
    color: #f85149;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    padding: 0 0.15rem;
  }

  .file-item .fremove:hover { color: #ff7b72; }
</style>
</head>
<body>

<header>
  <h1>support-bug tracker</h1>
  <button class="btn-new" onclick="openModal()">+ New Issue</button>
</header>

<div id="app"></div>

<!-- ── New Issue Modal ────────────────────────────── -->
<div id="overlay" class="overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-head">
      <h2>New Issue</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input id="m-title" type="text" placeholder="Title" />
      <textarea id="m-body" rows="5" placeholder="Description..."></textarea>
      <div id="m-drop" class="drop-zone">Drop files here or click to browse</div>
      <input id="m-file" type="file" multiple hidden />
      <div id="m-files" class="file-list"></div>
      <p id="m-error" class="modal-error"></p>
    </div>
    <div class="modal-foot">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-submit" id="btn-submit" onclick="submitIssue()">Create Issue</button>
    </div>
  </div>
</div>

<script>
// ── Configure these ─────────────────────────────────
const REPO        = "";
const PROXY_URL   = "";   // e.g. https://github-proxy.<you>.workers.dev
const PROXY_TOKEN = "";   // the secret you set via `wrangler secret put PROXY_TOKEN`
// ─────────────────────────────────────────────────────

const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
const LABEL = "support-bug";

// ── Helpers ──────────────────────────────────────────

function daysAgo(dateStr) {
  const ms = Date.now() - new Date(dateStr).getTime();
  const d = Math.floor(ms / (1000 * 60 * 60 * 24));
  if (d === 0) return "today";
  if (d === 1) return "1 day ago";
  return d + " days ago";
}


function icon(issue) {
  if (issue.state === "closed") return '<span class="icon" style="color:#3fb950">&#10003;</span>';
  const age = Date.now() - new Date(issue.created_at).getTime();
  if (age > ONE_WEEK) return '<span class="icon" style="color:#f85149">&#9203;</span>';
  return '<span class="icon" style="color:#d29922">&#9203;</span>';
}

function escHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

function apiHeaders() {
  return {
    Accept: "application/vnd.github+json",
    Authorization: "Bearer " + PROXY_TOKEN,
  };
}


// ── Fetch & Render ───────────────────────────────────

async function fetchIssues() {
  const app = document.getElementById("app");

  if (!REPO || REPO === "owner/repo" || !PROXY_URL) {
    app.innerHTML = '<p class="error">Set REPO and PROXY_URL in the script config</p>';
    return;
  }

  app.innerHTML = '<p class="loading">loading&hellip;</p>';

  try {
    let all = [];
    for (const state of ["open", "closed"]) {
      let page = 1;
      while (true) {
        const url = `${PROXY_URL}/repos/${REPO}/issues?labels=${encodeURIComponent(LABEL)}&state=${state}&per_page=100&page=${page}`;
        const res = await fetch(url, { headers: apiHeaders() });
        if (!res.ok) throw new Error(`GitHub API ${res.status}: ${res.statusText}`);
        const data = await res.json();
        if (data.length === 0) break;
        all = all.concat(data.filter(i => !i.pull_request));
        if (data.length < 100) break;
        page++;
      }
    }

    all.sort((a, b) => {
      const order = { open: 0, closed: 1 };
      if (order[a.state] !== order[b.state]) return order[a.state] - order[b.state];
      return new Date(b.created_at) - new Date(a.created_at);
    });

    render(all);
  } catch (e) {
    app.innerHTML = `<p class="error">${escHtml(e.message)}</p>`;
  }
}

function render(issues) {
  const app = document.getElementById("app");

  if (issues.length === 0) {
    app.innerHTML = '<p class="empty">No issues with label <strong>support-bug</strong></p>';
    return;
  }

  const open = issues.filter(i => i.state === "open");
  const closed = issues.filter(i => i.state === "closed");
  const stale = open.filter(i => Date.now() - new Date(i.created_at).getTime() > ONE_WEEK);

  let html = `
    <div class="stats">
      <div class="stat"><strong>${issues.length}</strong>total</div>
      <div class="stat"><strong>${open.length}</strong>open</div>
      <div class="stat"><strong>${stale.length}</strong>stale (&gt;7d)</div>
      <div class="stat"><strong>${closed.length}</strong>closed</div>
    </div>
    <div id="issues">`;

  for (const issue of issues) {
    const titleColor = issue.state === "closed" ? "#3fb950"
      : Date.now() - new Date(issue.created_at).getTime() > ONE_WEEK ? "#f85149"
      : "#e6edf3";
    html += `
      <a class="issue" href="${issue.html_url}" target="_blank" rel="noopener">
        ${icon(issue)}
        <div class="body">
          <div class="title" style="color:${titleColor}">#${issue.number} ${escHtml(issue.title)}</div>
          <div class="meta">${escHtml(issue.user.login)} &middot; ${daysAgo(issue.created_at)}</div>
        </div>
        <div class="age">${issue.state}</div>
      </a>`;
  }

  html += `</div>
    <div class="legend">
      <span style="color:#3fb950">&#10003; closed</span>
      <span style="color:#d29922">&#9203; open &lt; 7 days</span>
      <span style="color:#f85149">&#9203; open &gt; 7 days</span>
    </div>`;

  app.innerHTML = html;
}

// ── Files ────────────────────────────────────────────

let pendingFiles = [];

function initDropZone() {
  const drop = document.getElementById("m-drop");
  const input = document.getElementById("m-file");

  drop.addEventListener("click", () => input.click());

  input.addEventListener("change", () => {
    addFiles(input.files);
    input.value = "";
  });

  drop.addEventListener("dragover", e => {
    e.preventDefault();
    drop.classList.add("dragover");
  });

  drop.addEventListener("dragleave", () => drop.classList.remove("dragover"));

  drop.addEventListener("drop", e => {
    e.preventDefault();
    drop.classList.remove("dragover");
    addFiles(e.dataTransfer.files);
  });
}

function addFiles(fileList) {
  for (const f of fileList) {
    if (pendingFiles.some(p => p.name === f.name && p.size === f.size)) continue;
    pendingFiles.push(f);
  }
  renderFiles();
}

function removeFile(idx) {
  pendingFiles.splice(idx, 1);
  renderFiles();
}

function renderFiles() {
  const container = document.getElementById("m-files");
  if (pendingFiles.length === 0) { container.innerHTML = ""; return; }
  container.innerHTML = pendingFiles.map((f, i) => {
    const size = f.size < 1024 ? f.size + " B"
      : f.size < 1048576 ? (f.size / 1024).toFixed(1) + " KB"
      : (f.size / 1048576).toFixed(1) + " MB";
    return `<div class="file-item">
      <span class="fname">${escHtml(f.name)}</span>
      <span class="fsize">${size}</span>
      <button class="fremove" onclick="removeFile(${i})">&times;</button>
    </div>`;
  }).join("");
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result.split(",")[1]);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function uploadFiles() {
  const links = [];
  for (const file of pendingFiles) {
    const ts = Date.now();
    const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
    const path = `uploads/${ts}-${safeName}`;
    const content = await readFileAsBase64(file);
    const res = await fetch(`${PROXY_URL}/repos/${REPO}/contents/${path}`, {
      method: "PUT",
      headers: { ...apiHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify({ message: `upload ${file.name}`, content }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(`Upload failed for ${file.name}: ${err.message || res.status}`);
    }
    const data = await res.json();
    const url = data.content.download_url;
    const isImage = /\.(png|jpe?g|gif|webp|svg)$/i.test(file.name);
    links.push(isImage ? `![${file.name}](${url})` : `[${file.name}](${url})`);
  }
  return links;
}

// ── Modal ────────────────────────────────────────────

function openModal() {
  document.getElementById("m-title").value = "";
  document.getElementById("m-body").value = "";
  document.getElementById("m-error").style.display = "none";
  pendingFiles = [];
  renderFiles();
  document.getElementById("overlay").classList.add("open");
  document.getElementById("m-title").focus();
}

function closeModal() {
  document.getElementById("overlay").classList.remove("open");
}


// ── Submit ───────────────────────────────────────────

async function submitIssue() {
  const title = document.getElementById("m-title").value.trim();
  const body = document.getElementById("m-body").value.trim();
  const errEl = document.getElementById("m-error");
  const btn = document.getElementById("btn-submit");

  errEl.style.display = "none";

  if (!title) {
    errEl.textContent = "Title is required.";
    errEl.style.display = "block";
    return;
  }
  if (!PROXY_TOKEN) {
    errEl.textContent = "A proxy token is required to create issues. Set PROXY_TOKEN in the script config.";
    errEl.style.display = "block";
    return;
  }

  btn.disabled = true;
  btn.textContent = "Creating...";

  try {
    let fileLinks = [];
    if (pendingFiles.length) {
      btn.textContent = `Uploading ${pendingFiles.length} file(s)...`;
      fileLinks = await uploadFiles();
    }

    const fullBody = fileLinks.length
      ? (body ? body + "\n\n" : "") + "**Attachments**\n" + fileLinks.join("\n")
      : body;

    btn.textContent = "Creating issue...";
    const res = await fetch(`${PROXY_URL}/repos/${REPO}/issues`, {
      method: "POST",
      headers: { ...apiHeaders(), "Content-Type": "application/json" },
      body: JSON.stringify({ title, body: fullBody, labels: [LABEL] }),
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || `GitHub API ${res.status}`);
    }

    closeModal();
    document.getElementById("app").innerHTML = '<p class="loading">&#9203; Refreshing issues&hellip;</p>';
    await new Promise(r => setTimeout(r, 8000));
    fetchIssues();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.style.display = "block";
  } finally {
    btn.disabled = false;
    btn.textContent = "Create Issue";
  }
}

// ── Init ─────────────────────────────────────────────
initDropZone();
fetchIssues();
</script>
</body>
</html>
